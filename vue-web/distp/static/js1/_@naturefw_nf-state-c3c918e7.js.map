{"version":3,"file":"_@naturefw_nf-state-c3c918e7.js","sources":["../../../node_modules/@naturefw/nf-state/dist/nfState.es.js"],"sourcesContent":["import { isReactive, readonly, provide, inject, toRaw, reactive, computed } from \"vue\";\nconst _storeFlag = Symbol(\"__nf-state__\");\nconst _stateList = {};\nconst store = _stateList;\nconst defineStore = (id, info, options = {}) => {\n  var _a;\n  const isLocal = (_a = options.isLocal) != null ? _a : false;\n  const _level = options.level ? options.level : 1;\n  if (isLocal)\n    ;\n  else {\n    if (Object.keys(_stateList).includes(id)) {\n      const stack = new Error().stack;\n      console.log(stack);\n      throw `\\u5168\\u5C40\\u72B6\\u6001\\u7684ID\\uFF08${id}\\uFF09\\u4E0D\\u80FD\\u91CD\\u590D\\uFF01`;\n    }\n  }\n  let tmp = null;\n  if (isReactive(info)) {\n    tmp = info;\n  } else {\n    if (info.getters || info.actions) {\n      tmp = stateReactive(id, info, options);\n    } else {\n      const _state = info.state ? info.state : info;\n      tmp = stateOnly(id, _state, options);\n    }\n  }\n  const re = _level === 1 ? tmp : readonly(tmp);\n  if (isLocal) {\n    provide(id, re);\n  } else {\n    _stateList[id] = re;\n  }\n  return tmp;\n};\nconst createStore = (info) => {\n  const _store = info.store;\n  Object.keys(_store).forEach((key) => {\n    const __state = _store[key];\n    const options = __state.options ? __state.options : {\n      isLocal: false,\n      isLog: false,\n      level: 1\n    };\n    if (__state.state) {\n      defineStore(key, __state, options);\n    } else {\n      defineStore(key, { state: __state }, options);\n    }\n  });\n  if (typeof info.init === \"function\") {\n    info.init(_stateList);\n  }\n  return (app, options) => {\n    app.config.globalProperties.$state = _stateList;\n    app.provide(_storeFlag, store);\n  };\n};\nconst useStore = (flag = _storeFlag) => {\n  var _a;\n  const re = (_a = inject(flag)) != null ? _a : store;\n  return re;\n};\nclass BaseArray extends Array {\n  constructor(_info) {\n    super();\n    if (Array.isArray(_info)) {\n      this.push(..._info);\n    } else {\n      this.push(_info);\n    }\n  }\n  $reset() {\n    this.length = 0;\n    const _val = typeof this._value === \"function\" ? this._value() : this._value;\n    this.push(..._val);\n  }\n  $patch() {\n  }\n  set $state(value) {\n    this.length = 0;\n    if (Array.isArray(value)) {\n      this.push(...value);\n    } else {\n      this.push(value);\n    }\n  }\n  pushA() {\n    return this.unshift(...arguments);\n  }\n  pushAt(i, val) {\n    console.log(arguments);\n    const tmp = Array.from(arguments).slice(1);\n    this.splice(i, 0, ...tmp);\n    return this.length;\n  }\n  deletaA() {\n    return this.shift();\n  }\n  deleteAt(i, n) {\n    return this.splice(i, n);\n  }\n  deleteZ() {\n    return this.pop();\n  }\n  swap(i1, i2) {\n    const tmp = this[i1];\n    this[i1] = this[i2];\n    this[i2] = tmp;\n  }\n}\nconst deepSet = (target, _source) => {\n  const source = toRaw(_source);\n  Object.keys(source).forEach((key) => {\n    switch (typeof source[key]) {\n      case \"object\":\n        if (Array.isArray(source[key])) {\n          if (Array.isArray(target[key])) {\n            target[key].length = 0;\n          } else {\n            target[key] = new BaseArray();\n          }\n          target[key].push(...source[key]);\n        } else {\n          if (!target[key]) {\n            target[key] = {};\n          }\n          if (source[key] === null) {\n            target[key] = null;\n          } else {\n            deepSet(target[key], source[key]);\n          }\n        }\n        break;\n      case \"bigint\":\n      case \"boolean\":\n      case \"number\":\n      case \"string\":\n        target[key] = source[key];\n        break;\n    }\n  });\n  return target;\n};\nconst deepClone = (target, _source) => {\n  const source = toRaw(_source);\n  Object.keys(source).forEach((key) => {\n    switch (typeof source[key]) {\n      case \"object\":\n        if (Array.isArray(source[key])) {\n          target[key] = new BaseArray(source[key]);\n        } else {\n          target[key] = {};\n          deepClone(target[key], source[key]);\n        }\n        break;\n      case \"bigint\":\n      case \"boolean\":\n      case \"number\":\n      case \"string\":\n        target[key] = source[key];\n        break;\n    }\n  });\n  return target;\n};\nconst stateLog = reactive({});\nconst addLog = (key, kind, oldVal, newVal, subVal = {}, stackIndex = 3) => {\n  if (!stateLog[key]) {\n    stateLog[key] = { log: [] };\n  }\n  if (kind === \"init\")\n    return;\n  const stack = new Error().stack;\n  const arr = stack.split(\"\\n\");\n  const stackstr = arr.length > stackIndex ? arr[stackIndex] : arr[arr.length - 1];\n  const _oldVal = isReactive(oldVal) ? deepClone({}, oldVal) : oldVal;\n  const _newVal = isReactive(newVal) ? deepClone({}, newVal) : newVal;\n  const _subVal = isReactive(subVal) ? deepClone({}, subVal) : subVal;\n  stateLog[key].log.push({\n    time: new Date().valueOf(),\n    kind,\n    oldValue: _oldVal,\n    newValue: _newVal,\n    subValue: _subVal,\n    callFun: stackstr\n  });\n};\nclass BaseClass {\n  constructor(_info) {\n    if (typeof _info === \"function\") {\n      const val = _info();\n      Object.keys(val).forEach((key) => {\n        const p = val[key];\n        if (Array.isArray(p)) {\n          this[key] = new BaseArray(p);\n        } else {\n          this[key] = p;\n        }\n      });\n    } else {\n      deepClone(this, _info);\n    }\n    addLog(this.$id, \"init\", {}, {});\n  }\n  $reset() {\n    if (!this._value)\n      return;\n    const v = this._value;\n    const newVal = typeof v === \"function\" ? v() : deepClone({}, v);\n    if (this.isLog) {\n      addLog(this.$id, \"$reset\", this, newVal);\n    }\n    this.$state = newVal;\n  }\n  $patch(_val) {\n    const val = typeof _val === \"function\" ? _val(this) : _val;\n    const oldVal = this.isLog ? deepClone({}, this) : \"\";\n    deepSet(this, val);\n    if (this.isLog) {\n      addLog(this.$id, \"$patch\", oldVal, this, val);\n    }\n  }\n  set $state(value) {\n    const oldVal = this.isLog ? deepClone({}, this) : \"\";\n    Object.keys(this).forEach((key) => {\n      delete this[key];\n    });\n    Object.assign(this, value);\n    if (this.isLog) {\n      addLog(this.$id, \"$state\", oldVal, this, value);\n    }\n  }\n  forEach(cb) {\n    if (typeof cb === \"function\") {\n      Object.keys(this).forEach((key, index) => {\n        const obj = this[key];\n        cb(obj, key, index);\n      });\n    }\n  }\n  get log() {\n    return stateLog[this.$id].log;\n  }\n}\nfunction stateReactive(id, info, options = {}) {\n  let tmp = null;\n  let basec = null;\n  const _state = typeof info.state === \"function\" ? info.state() : info.state;\n  if (Array.isArray(_state)) {\n    class arrayClass extends BaseArray {\n      constructor(_info) {\n        super(_info);\n      }\n      get isLog() {\n        return !!options.isLog;\n      }\n      get $id() {\n        return id;\n      }\n    }\n    basec = arrayClass;\n    tmp = new arrayClass(_state);\n  } else {\n    class objClass extends BaseClass {\n      constructor(_info) {\n        super(_info);\n      }\n      get isLog() {\n        return !!options.isLog;\n      }\n      get _value() {\n        return info.state;\n      }\n      get $id() {\n        return id;\n      }\n    }\n    basec = objClass;\n    tmp = new objClass(_state);\n  }\n  const ret = reactive(tmp);\n  const _level = options.level ? options.level : 1;\n  if (_level === 2) {\n    const _$patch = ret.$patch;\n    basec.prototype.$patch = function(_val) {\n      _$patch.call(ret, _val);\n    };\n    const _$reset = ret.$reset;\n    basec.prototype.$reset = function(_val) {\n      _$reset.call(ret, _val);\n    };\n    basec.prototype.state = function(_val) {\n      ret.$state = _val;\n    };\n  }\n  if (typeof info.getters === \"object\") {\n    Object.keys(info.getters).forEach((key) => {\n      basec.prototype[key] = computed(() => {\n        const oldVal = ret.isLog ? deepClone({}, ret) : \"\";\n        const re = info.getters[key].call(ret, ret);\n        if (ret.isLog) {\n          addLog(ret.$id, `getters-${_level}-${key}`, oldVal, ret, {});\n        }\n        return re;\n      });\n    });\n  }\n  if (typeof info.actions === \"object\") {\n    Object.keys(info.actions).forEach((key) => {\n      basec.prototype[key] = async function(val) {\n        const oldVal = ret.isLog ? deepClone({}, ret) : \"\";\n        if (_level < 4) {\n          await info.actions[key].call(ret, val, ret);\n        } else {\n          await info.actions[key].call(this, val, this);\n        }\n        if (ret.isLog) {\n          addLog(ret.$id, `actions-${_level}-${key}`, oldVal, ret, val);\n        }\n      };\n    });\n  }\n  return ret;\n}\nfunction stateOnly(id, state, options = {}) {\n  let tmp = null;\n  const _state = typeof state === \"function\" ? state() : state;\n  if (Array.isArray(_state)) {\n    tmp = new BaseArray(state);\n  } else {\n    tmp = new BaseClass(state);\n  }\n  tmp._value = () => state;\n  tmp.$id = () => id;\n  tmp.isLog = () => !!options.isLog;\n  const ret = reactive(tmp);\n  return ret;\n}\nexport { BaseArray, BaseClass, createStore, deepClone, deepSet, defineStore, stateOnly, stateReactive, store, useStore };\n//# sourceMappingURL=nfState.es.js.map\n"],"names":[],"mappings":"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"}